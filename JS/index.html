<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Visual Scripting!</title>
    <link rel="stylesheet" type="text/css" href="main.css">
</head>
<body>
    <div id="layout-container" style="height: 100%; display: flex; flex-flow: column;">
        <div style="display:flex; overflow:auto">
            <div id="header" style="display: flex;"></div>
            <div style="flex: 1; border-bottom: solid 2px;"></div>
        </div>
        <div id="content" style="display: flex; flex: 1; border-style: solid; border-width: 2px; border-top: 0px;  margin-bottom: 0px;"></div>
    </div>
    <div id ="modal_space" style="display: none; position: absolute; left: 0px; top: 0px; width: 100%; height: 100%"></div>
    <script>
        {
            const { readDirectory, ejsDir, defsDir, assetsDir, trashDir, constructDefs, serializeDefToXML } = require('./init');

            async function init() {
                let ejsData = readDirectory(ejsDir);
                let defs = readDirectory(defsDir);
                let assets = readDirectory(assetsDir);

                ejsData = await ejsData;
                defs = await defs;
                assets = await assets;

                for (let k in assets) {
                    defs[k] = assets[k];
                }

                const {
                    parsed,
                    bool,
                    int,
                    float,
                    string,
                    type,
                    valueType,
                    referenceType,
                    list
                } = constructDefs(defs);

                const appData = {
                    ejsData: ejsData,
                    defs: parsed,
                    specialTypes: {
                        bool,
                        int,
                        float,
                        string,
                        type,
                        valueType,
                        referenceType,
                        list
                    },
                    enumerateDefs: function* () {
                        for (let key in parsed) {
                            yield parsed[key];
                        }
                    },
                    isAssignable: (id1, id2) => {
                        const type1 = appData.defs[id1];
                        const type2 = appData.defs[id2];

                        if (type1 === type2) {
                            return true;
                        }

                        if (!type1.parent) {
                            return false;
                        }
                        return appData.isAssignable(type1.parent.id, id2);
                    },
                    enumerateReferenced: function* () {
                        const it = appData.enumerateDefs();

                        let cur = it.next();
                        while (!cur.done) {
                            if (appData.isAssignable(cur.value.id.id, referenceType.id.id)) {
                                yield cur.value;
                            }
                            cur = it.next();
                        }
                    },
                    enumerateAssignable: function* (type) {
                        const it = appData.enumerateDefs();

                        let cur = it.next();
                        while (!cur.done) {
                            if (appData.isAssignable(cur.value.id.id, type.id.id)) {
                                yield cur.value;
                            }
                            cur = it.next();
                        }
                    },
                    serialiDefToXML: serializeDefToXML,
                    saveAssets: async () => {
                        const path = require('path');
                        const fs = require('fs');

                        const it = appData.enumerateDefs();
                        let cur = it.next();

                        let proms = [];

                        while (!cur.done) {
                            let item = cur.value;
                            cur = it.next();
                            if (!item.isGenerated) {
                                continue;
                            }

                            const tmp = new Promise((resolve, reject) => {
                                let fileName = path.join(assetsDir, item.id.id + '.json');
                                fs.writeFile(fileName, JSON.stringify(item), () => {
                                    resolve();
                                });
                            });

                            proms.push(tmp);
                        }

                        for (let i = 0; i < proms.length; ++i) {
                            await proms[i];
                        }

                        console.log('Assets Saved!');
                    },
                    moveAssetToTrash: async filename => {
                        const path = require('path');
                        const fs = require('fs');

                        const fullPath = path.join(assetsDir, filename);
                        const trashPath = path.join(trashDir, filename);

                        return new Promise((resolve, reject) => {
                            fs.rename(fullPath, trashPath, () => {
                                resolve();
                            });
                        });
                    }
                };

                document.appData = appData;

                const { create } = require('./dom/contentBrowser');
                create();
            }

            init();
        }
    </script>
</body>
</html>
